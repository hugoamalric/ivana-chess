<div *ngIf="user === null; else body" class="row mt-4">
  <div class="col-12 text-center">
    <span class="spinner-border spinner-border-sm text-dark"></span> Loading...
  </div>
</div>

<ng-template #body>
  <div class="row mt-2">
    <h1 class="col-12">{{ user!!.pseudo }}</h1>
  </div>

  <div *ngIf="me?.id === user!!.id" class="row mt-2">
    <h3 class="col-12">My information</h3>

    <form class="col-12 col-lg-6" [formGroup]="updateEmailForm" (ngSubmit)="updateEmail()" autocomplete="off">
      <div class="form-group">
        <label for="email">Email</label>
        <div class="form-row">
          <div class="col-11">
            <input id="email"
                   name="email"
                   type="text"
                   formControlName="email"
                   class="form-control"
                   [ngClass]="{'is-invalid': (email.touched || email.dirty) && (email.invalid || emailExists)}" />
            <div *ngIf="email.invalid || emailExists" class="invalid-feedback">
              <span *ngIf="email.errors?.required">Email is required</span>
              <span *ngIf="email.errors?.email">Email must be valid</span>
              <span *ngIf="emailExists">Email is already used</span>
            </div>
          </div>
          <div *ngIf="checkingEmail" class="col-1 pt-1">
            <span class="spinner-border spinner-border-sm text-secondary"></span>
          </div>
        </div>
      </div>
      <button type="submit"
              [disabled]="!updateEmailForm.valid || emailExists || updatePending"
              class="btn btn-primary">
        <ng-container *ngIf="updatePending else updateButton">
          <span class="spinner-border spinner-border-sm text-light"></span> Updating...
        </ng-container>
        <ng-template #updateButton>Update</ng-template>
      </button>
    </form>

    <h3 class="col-12 mt-2">Security</h3>

    <form class="col-12 col-lg-6" [formGroup]="updatePasswordForm" (ngSubmit)="updatePassword()" autocomplete="off">
      <div class="form-group">
        <label for="password">Password</label>
        <div class="form-row">
          <div class="col-11">
            <input id="password"
                   name="password"
                   type="password"
                   formControlName="password"
                   class="form-control"
                   [ngClass]="{'is-invalid': (password.touched || password.dirty) && password.invalid}" />
            <div *ngIf="password.invalid" class="invalid-feedback">
              <span *ngIf="password.errors!!.required">Password is required</span>
              <span *ngIf="password.errors!!.minlength">
              Password must contains at least {{ PasswordMinLength }} characters
            </span>
            </div>
          </div>
        </div>
      </div>
      <div class="form-group">
        <label for="passwordConfirmation">Password confirmation</label>
        <div class="form-row">
          <div class="col-11">
            <input id="passwordConfirmation"
                   name="passwordConfirmation"
                   type="password"
                   formControlName="passwordConfirmation"
                   class="form-control"
                   [ngClass]="{'is-invalid': (passwordConfirmation.touched || passwordConfirmation.dirty) && (passwordConfirmation.invalid || updatePasswordForm.errors?.passwordConfirmation)}" />
            <div *ngIf="passwordConfirmation.invalid || updatePasswordForm.errors?.passwordConfirmation"
                 class="invalid-feedback">
              <span *ngIf="passwordConfirmation.errors?.required">Password confirmation is required</span>
              <span
                *ngIf="updatePasswordForm.errors?.passwordConfirmation">Password confirmation must match password</span>
            </div>
          </div>
        </div>
      </div>
      <button type="submit"
              [disabled]="!updatePasswordForm.valid || updatePending"
              class="btn btn-primary">
        <ng-container *ngIf="updatePending else updateButton">
          <span class="spinner-border spinner-border-sm text-light"></span> Updating...
        </ng-container>
        <ng-template #updateButton>Update</ng-template>
      </button>
    </form>

    <ng-container *ngIf="user!!.role !== Role.SuperAdmin">
      <h3 class="col-12 mt-2">Danger zone</h3>

      <div class="col-12">
        <button class="btn btn-danger" [disabled]="deletionPending || updatePending" (click)="openConfirmWindow()">
          <ng-container *ngIf="deletionPending else deleteButton">
            <span class="spinner-border spinner-border-sm text-light"></span> Deleting...
          </ng-container>
          <ng-template #deleteButton>Delete my account</ng-template>
        </button>
      </div>
    </ng-container>
  </div>
</ng-template>
